x-go-service: &go-service
  build:
    context: .
    dockerfile: Dockerfile
  working_dir: /app
  volumes:
    - .:/app

services:
  chromadb:
    image: chromadb/chroma:0.5.4
    environment:
      CHROMA_SERVER_HOST: "0.0.0.0"
      CHROMA_SERVER_PORT: "8000"
      PERSIST_DIRECTORY: "/chroma/chroma"
    ports:
      - "8000:8000"
    volumes:
      - ./data/chroma:/chroma/chroma
    logging:
      driver: "none"

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    logging:
      driver: "none"

  kafka-broker:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-broker:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    logging:
      driver: "none"

  polymarket-collector:
    <<: *go-service
    command: [ "go", "run", "./cmd/polymarket_collector" ]
    depends_on:
      - kafka-broker
    environment:
      GO111MODULE: "on"
      POLYMARKET_PAGE_SIZE: ${POLYMARKET_PAGE_SIZE:-50}
      SQLITE_PATH: ${SQLITE_PATH:-/app/data/arb.db}
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka-broker:9092}
      POLYMARKET_KAFKA_TOPIC: ${POLYMARKET_KAFKA_TOPIC:-polymarket.snapshots}

  polymarket-collector-dev:
    <<: *go-service
    command: [ "go", "run", "./cmd/polymarket_collector_dev" ]
    depends_on:
      - kafka-broker
    environment:
      GO111MODULE: "on"
      POLYMARKET_PAGE_SIZE: ${POLYMARKET_PAGE_SIZE:-50}
      SQLITE_PATH: ${SQLITE_PATH:-/app/data/arb.db}
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka-broker:9092}
      POLYMARKET_KAFKA_TOPIC: ${POLYMARKET_KAFKA_TOPIC:-polymarket.snapshots}

  kalshi-collector:
    <<: *go-service
    command: [ "go", "run", "./cmd/kalshi_collector" ]
    depends_on:
      - kafka-broker
    environment:
      GO111MODULE: "on"
      KALSHI_PAGE_SIZE: ${KALSHI_PAGE_SIZE:-100}
      SQLITE_PATH: ${SQLITE_PATH:-/app/data/arb.db}
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka-broker:9092}
      KALSHI_KAFKA_TOPIC: ${KALSHI_KAFKA_TOPIC:-kalshi.snapshots}

  kalshi-collector-dev:
    <<: *go-service
    command: [ "go", "run", "./cmd/kalshi_collector_dev" ]
    depends_on:
      - kafka-broker
    environment:
      GO111MODULE: "on"
      KALSHI_PAGE_SIZE: ${KALSHI_PAGE_SIZE:-100}
      SQLITE_PATH: ${SQLITE_PATH:-/app/data/arb.db}
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka-broker:9092}
      KALSHI_KAFKA_TOPIC: ${KALSHI_KAFKA_TOPIC:-kalshi.snapshots}

  polymarket-worker:
    <<: *go-service
    depends_on:
      - kafka-broker
      - chromadb
    command: [ "go", "run", "./cmd/polymarket_worker" ]
    environment:
      GO111MODULE: "on"
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka-broker:9092}
      POLYMARKET_KAFKA_TOPIC: ${POLYMARKET_KAFKA_TOPIC:-polymarket.snapshots}
      POLYMARKET_WORKER_GROUP: ${POLYMARKET_WORKER_GROUP:-polymarket-workers}
      POLYMARKET_WORKERS: ${POLYMARKET_WORKERS:-2}
      MATCH_DEBUG: ${MATCH_DEBUG:-0}
      MATCH_TOP_K: ${MATCH_TOP_K:-3}
      MATCH_SIMILARITY_THRESHOLD: ${MATCH_SIMILARITY_THRESHOLD:-0.95}
      MATCH_FRESH_WINDOW_SECONDS: ${MATCH_FRESH_WINDOW_SECONDS:-600}
      NEBIUS_API_KEY: ${NEBIUS_API_KEY}
      NEBIUS_BASE_URL: ${NEBIUS_BASE_URL:-https://api.tokenfactory.nebius.com/v1/}
      NEBIUS_EMBED_MODEL: ${NEBIUS_EMBED_MODEL:-}
      CHROMA_URL: ${CHROMA_URL:-http://chromadb:8000}
      CHROMA_COLLECTION: ${CHROMA_COLLECTION:-market_snapshots}

  polymarket-worker-dev:
    <<: *go-service
    depends_on:
      - kafka-broker
      - chromadb
    command: [ "go", "run", "./cmd/polymarket_worker_dev" ]
    environment:
      GO111MODULE: "on"
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka-broker:9092}
      POLYMARKET_KAFKA_TOPIC: ${POLYMARKET_KAFKA_TOPIC:-polymarket.snapshots}
      POLYMARKET_WORKER_GROUP: ${POLYMARKET_WORKER_GROUP:-polymarket-workers-dev}
      POLYMARKET_WORKERS: ${POLYMARKET_WORKERS:-1}
      POLYMARKET_WORKER_VERBOSE: ${POLYMARKET_WORKER_VERBOSE:-0}
      MATCH_DEBUG: ${MATCH_DEBUG:-0}
      MATCH_TOP_K: ${MATCH_TOP_K:-3}
      MATCH_SIMILARITY_THRESHOLD: ${MATCH_SIMILARITY_THRESHOLD:-0.95}
      MATCH_FRESH_WINDOW_SECONDS: ${MATCH_FRESH_WINDOW_SECONDS:-600}
      NEBIUS_API_KEY: ${NEBIUS_API_KEY}
      NEBIUS_BASE_URL: ${NEBIUS_BASE_URL:-https://api.tokenfactory.nebius.com/v1/}
      NEBIUS_EMBED_MODEL: ${NEBIUS_EMBED_MODEL:-}
      CHROMA_URL: ${CHROMA_URL:-http://chromadb:8000}
      CHROMA_COLLECTION: ${CHROMA_COLLECTION:-market_snapshots}

  kalshi-worker:
    <<: *go-service
    depends_on:
      - kafka-broker
      - chromadb
    command: [ "go", "run", "./cmd/kalshi_worker" ]
    environment:
      GO111MODULE: "on"
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka-broker:9092}
      KALSHI_KAFKA_TOPIC: ${KALSHI_KAFKA_TOPIC:-kalshi.snapshots}
      KALSHI_WORKER_GROUP: ${KALSHI_WORKER_GROUP:-kalshi-workers}
      KALSHI_WORKERS: ${KALSHI_WORKERS:-2}
      MATCH_DEBUG: ${MATCH_DEBUG:-0}
      MATCH_TOP_K: ${MATCH_TOP_K:-3}
      MATCH_SIMILARITY_THRESHOLD: ${MATCH_SIMILARITY_THRESHOLD:-0.95}
      MATCH_FRESH_WINDOW_SECONDS: ${MATCH_FRESH_WINDOW_SECONDS:-600}
      NEBIUS_API_KEY: ${NEBIUS_API_KEY}
      NEBIUS_BASE_URL: ${NEBIUS_BASE_URL:-https://api.tokenfactory.nebius.com/v1/}
      NEBIUS_EMBED_MODEL: ${NEBIUS_EMBED_MODEL:-}
      CHROMA_URL: ${CHROMA_URL:-http://chromadb:8000}
      CHROMA_COLLECTION: ${CHROMA_COLLECTION:-market_snapshots}

  kalshi-worker-dev:
    <<: *go-service
    depends_on:
      - kafka-broker
      - chromadb
    command: [ "go", "run", "./cmd/kalshi_worker_dev" ]
    environment:
      GO111MODULE: "on"
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka-broker:9092}
      KALSHI_KAFKA_TOPIC: ${KALSHI_KAFKA_TOPIC:-kalshi.snapshots}
      KALSHI_WORKER_GROUP: ${KALSHI_WORKER_GROUP:-kalshi-workers-dev}
      KALSHI_WORKERS: ${KALSHI_WORKERS:-1}
      KALSHI_WORKER_VERBOSE: ${KALSHI_WORKER_VERBOSE:-0}
      MATCH_DEBUG: ${MATCH_DEBUG:-0}
      MATCH_TOP_K: ${MATCH_TOP_K:-3}
      MATCH_SIMILARITY_THRESHOLD: ${MATCH_SIMILARITY_THRESHOLD:-0.95}
      MATCH_FRESH_WINDOW_SECONDS: ${MATCH_FRESH_WINDOW_SECONDS:-600}
      NEBIUS_API_KEY: ${NEBIUS_API_KEY}
      NEBIUS_BASE_URL: ${NEBIUS_BASE_URL:-https://api.tokenfactory.nebius.com/v1/}
      NEBIUS_EMBED_MODEL: ${NEBIUS_EMBED_MODEL:-}
      CHROMA_URL: ${CHROMA_URL:-http://chromadb:8000}
      CHROMA_COLLECTION: ${CHROMA_COLLECTION:-market_snapshots}

  arb-engine:
    <<: *go-service
    depends_on:
      - kafka-broker
    command: [ "go", "run", "./cmd/arb_engine" ]
    environment:
      GO111MODULE: "on"
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka-broker:9092}
      MATCHES_KAFKA_TOPIC: ${MATCHES_KAFKA_TOPIC:-matches.live}
      ARB_ENGINE_GROUP: ${ARB_ENGINE_GROUP:-arb-engine}
      ARB_ENGINE_WORKERS: ${ARB_ENGINE_WORKERS:-1}
      ARB_ENGINE_BUDGET_USD: ${ARB_ENGINE_BUDGET_USD:-100}

  snapshot-worker:
    <<: *go-service
    depends_on:
      - kafka-broker
    command: [ "go", "run", "./cmd/snapshot_worker" ]
    environment:
      GO111MODULE: "on"
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka-broker:9092}
      MATCHES_KAFKA_TOPIC: ${MATCHES_KAFKA_TOPIC:-matches.live}
      SNAPSHOT_WORKER_GROUP: ${SNAPSHOT_WORKER_GROUP:-snapshot-worker}
      SNAPSHOT_WORKER_CONCURRENCY: ${SNAPSHOT_WORKER_CONCURRENCY:-1}
      SNAPSHOT_WORKER_BUDGET_USD: ${SNAPSHOT_WORKER_BUDGET_USD:-100}
      SNAPSHOT_WORKER_FORCE_VALIDATION: ${SNAPSHOT_WORKER_FORCE_VALIDATION:-0}
      NEBIUS_API_KEY: ${NEBIUS_API_KEY}
      NEBIUS_BASE_URL: ${NEBIUS_BASE_URL:-https://api.tokenfactory.nebius.com/v1/}
      VALIDATOR_MODEL: ${VALIDATOR_MODEL:-openai/gpt-oss-120b}
      VALIDATOR_TIMEOUT_SECONDS: ${VALIDATOR_TIMEOUT_SECONDS:-45}
      VALIDATOR_MAX_TOKENS: ${VALIDATOR_MAX_TOKENS:-800}
      VALIDATOR_SYSTEM_PROMPT: ${VALIDATOR_SYSTEM_PROMPT:-}

  sqlite-create:
    <<: *go-service
    command: [ "go", "run", "./cmd/sqlite_create_tables" ]
    environment:
      GO111MODULE: "on"
      SQLITE_PATH: ${SQLITE_PATH:-/app/data/arb.db}

  sqlite-drop:
    <<: *go-service
    command: [ "go", "run", "./cmd/sqlite_drop_tables" ]
    environment:
      GO111MODULE: "on"
      SQLITE_PATH: ${SQLITE_PATH:-/app/data/arb.db}

  sqlite-clear:
    <<: *go-service
    command: [ "go", "run", "./cmd/sqlite_clear_tables" ]
    environment:
      GO111MODULE: "on"
      SQLITE_PATH: ${SQLITE_PATH:-/app/data/arb.db}

  sqlite-migrate:
    <<: *go-service
    command: [ "go", "run", "./cmd/sqlite_migrate" ]
    environment:
      GO111MODULE: "on"
      SQLITE_PATH: ${SQLITE_PATH:-/app/data/arb.db}
